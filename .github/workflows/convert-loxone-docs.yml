---
name: Convert Loxone Communication Documentation

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  convert-pdf-to-markdown:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install PDF conversion tool
        run: |
          pip install pymupdf4llm

      - name: Create docs directory
        run: |
          mkdir -p docs/loxone

      - name: Download PDF
        run: |
          curl -L -o /tmp/loxone-communication.pdf "https://www.loxone.com/wp-content/uploads/datasheets/CommunicatingWithMiniserver.pdf"

      - name: Convert PDF to Markdown
        run: |
          python3 << 'EOF'
          import pymupdf4llm
          import os
          
          pdf_path = "/tmp/loxone-communication.pdf"
          output_path = "docs/loxone/CommunicatingWithMiniserver.md"
          
          # Convert PDF to markdown
          md_text = pymupdf4llm.to_markdown(pdf_path)
          
          # Write to file
          with open(output_path, 'w', encoding='utf-8') as f:
              f.write(md_text)
          
          print(f"âœ… Successfully converted PDF to Markdown")
          print(f"ðŸ“ Output file: {output_path}")
          print(f"ðŸ“Š File size: {os.path.getsize(output_path)} bytes")
          EOF

      - name: Add metadata to markdown
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          # Create a temporary file with header
          cat > /tmp/header.md << EOF
          # Communicating with Miniserver
          
          > **Note:** This document is automatically generated from the official Loxone PDF documentation.
          > Last updated: ${TIMESTAMP}
          > Source: https://www.loxone.com/wp-content/uploads/datasheets/CommunicatingWithMiniserver.pdf
          
          ---
          
          EOF
          
          # Prepend header to the converted markdown
          cat /tmp/header.md docs/loxone/CommunicatingWithMiniserver.md > /tmp/final.md
          mv /tmp/final.md docs/loxone/CommunicatingWithMiniserver.md

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.SMARTEON_GIT_TOKEN }}
          commit-message: "docs: update Loxone communication documentation from PDF"
          branch: docs/loxone-communication-update
          delete-branch: true
          title: "docs: Update Loxone Communication Documentation"
          body: |
            ## ðŸ“š Documentation Update
            
            This PR updates the Loxone Communication documentation by converting the official PDF to Markdown format.
            
            ### Changes
            - Converted PDF to Markdown using pymupdf4llm
            - Updated documentation in `docs/loxone/CommunicatingWithMiniserver.md`
            
            ### Source
            PDF URL: https://www.loxone.com/wp-content/uploads/datasheets/CommunicatingWithMiniserver.pdf
            
            ### How to Review
            1. Check the converted markdown file for formatting issues
            2. Verify that important information from the PDF is preserved
            3. Ensure code examples and tables are properly formatted
            
            ---
            
            *This PR was automatically generated by the Convert Loxone Documentation workflow.*
          labels: |
            documentation
            automated
